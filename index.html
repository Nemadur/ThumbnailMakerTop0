<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-latest.min.js"></script>
		<link rel="shortcut icon" type="image/jpg" href="./resources/top0logo.jpg"/>

        <script>

			(function($) {
				$.tablesort = function ($table, settings) {
					var self = this;
					this.$table = $table;
					this.$thead = this.$table.find('thead');
					this.settings = $.extend({}, $.tablesort.defaults, settings);
					this.$sortCells = this.$thead.length > 0 ? this.$thead.find('th:not(.no-sort)') : this.$table.find('th:not(.no-sort)');
					this.$sortCells.on('click.tablesort', function() {
						self.sort($(this));
					});
					this.index = null;
					this.$th = null;
					this.direction = null;
				};

				$.tablesort.prototype = {

					sort: function(th, direction) {
						var start = new Date(),
							self = this,
							table = this.$table,
							rowsContainer = table.find('tbody').length > 0 ? table.find('tbody') : table,
							rows = rowsContainer.find('tr').has('td, th'),
							cells = rows.find(':nth-child(' + (th.index() + 1) + ')').filter('td, th'),
							sortBy = th.data().sortBy,
							sortedMap = [];

						var unsortedValues = cells.map(function(idx, cell) {
							if (sortBy)
								return (typeof sortBy === 'function') ? sortBy($(th), $(cell), self) : sortBy;
							return ($(this).data().sortValue != null ? $(this).data().sortValue : $(this).text());
						});
						if (unsortedValues.length === 0) return;

						//click on a different column
						if (this.index !== th.index()) {
							this.direction = 'asc';
							this.index = th.index();
						}
						else if (direction !== 'asc' && direction !== 'desc')
							this.direction = this.direction === 'asc' ? 'desc' : 'asc';
						else
							this.direction = direction;

						direction = this.direction == 'asc' ? 1 : -1;

						self.$table.trigger('tablesort:start', [self]);
						self.log("Sorting by " + this.index + ' ' + this.direction);

						// Try to force a browser redraw
						self.$table.css("display");
						// Run sorting asynchronously on a timeout to force browser redraw after
						// `tablesort:start` callback. Also avoids locking up the browser too much.
						setTimeout(function() {
							self.$sortCells.removeClass(self.settings.asc + ' ' + self.settings.desc);
							for (var i = 0, length = unsortedValues.length; i < length; i++)
							{
								sortedMap.push({
									index: i,
									cell: cells[i],
									row: rows[i],
									value: unsortedValues[i]
								});
							}

							sortedMap.sort(function(a, b) {
								return self.settings.compare(a.value, b.value) * direction;
							});

							$.each(sortedMap, function(i, entry) {
								rowsContainer.append(entry.row);
							});

							th.addClass(self.settings[self.direction]);

							self.log('Sort finished in ' + ((new Date()).getTime() - start.getTime()) + 'ms');
							self.$table.trigger('tablesort:complete', [self]);
							//Try to force a browser redraw
							self.$table.css("display");
						}, unsortedValues.length > 2000 ? 200 : 10);
					},

					log: function(msg) {
						if(($.tablesort.DEBUG || this.settings.debug) && console && console.log) {
							console.log('[tablesort] ' + msg);
						}
					},

					destroy: function() {
						this.$sortCells.off('click.tablesort');
						this.$table.data('tablesort', null);
						return null;
					}

				};

				$.tablesort.DEBUG = false;

				$.tablesort.defaults = {
					debug: $.tablesort.DEBUG,
					asc: 'sorted ascending',
					desc: 'sorted descending',
					compare: function(a, b) {
						if (a > b) {
							return 1;
						} else if (a < b) {
							return -1;
						} else {
							return 0;
						}
					}
				};

				$.fn.tablesort = function(settings) {
					var table, sortable, previous;
					return this.each(function() {
						table = $(this);
						previous = table.data('tablesort');
						if(previous) {
							previous.destroy();
						}
						table.data('tablesort', new $.tablesort(table, settings));
					});
				};

			})(window.Zepto || window.jQuery);

        </script>

        <style>
            .fileSelect{
                margin: auto;
                margin-top: 20px;
                width: 50%;
            }
        </style>

        <script>

            $(document).ready(function() {
                $('#toSort').tablesort()
            });

			var audio = new Audio("./resources/top0Audio.wav");
			
            const imageHeight = 650;
            const imageWidth = 460;
            const textStart = 930;
            
            const createTitle = (ctx, count) => {
				const mainColor = document.querySelector('#MainColor').value;
				const bgColor = document.querySelector('#BgColor').value;
				const correction = document.querySelector('#BgCorrection').value;

                ctx.font = "bold 60px calibri";
                ctx.fillStyle = '#000'
                ctx.fillText("KAMPANIA", textStart, 80);
                ctx.fillText("CO-OP #" + count, textStart, 150);
                ctx.fillText("IMPOSSIBLE", textStart, 220);

                const move = 5
                ctx.fillStyle = '#fff'
                ctx.fillText("KAMPANIA", textStart + move, 80 + correction);
                ctx.fillText("CO-OP #" + count, textStart + move, 150  + correction);
                ctx.fillText("IMPOSSIBLE", textStart + move, 220  + correction);
            }

            const createThumbnail = (card, counter, background) => {
                const tableRow = document.createElement('tr');
                const tableCell  = document.createElement('td');
                const idCell  = document.createElement('td');
                idCell.innerHTML = counter

                const newThumbnail = document.createElement('canvas')
                newThumbnail.width = 1280
                newThumbnail.height = 720
                newThumbnail.id = `thumbnail-${counter}`

                const ctx = newThumbnail.getContext("2d");
            
                ctx.drawImage(background, 0, 0);
                createTitle(ctx, counter);
                ctx.drawImage(card, 20, 30, imageWidth, imageHeight);

                tableCell.appendChild(newThumbnail)
                tableRow.appendChild(idCell)
                tableRow.appendChild(tableCell)

                document.getElementById('main').appendChild(tableRow)
            }


            function generateThumbnails() {
				audio.play();
				document.querySelector("#main").innerHTML = "";

                const cards = document.querySelector('#fileItems');
                const background = document.querySelector('#fileBackground')
                var correction = document.getElementById('thumbnailCount').value
                
                const base = document.createElement('img')

                var backgroundFile = background.files[0]
                var bgReader = new FileReader();
                bgReader.onload = function(event) {
                    base.src = event.target.result;

                    base.addEventListener("load", () => {
                        for (let index = 0; index < cards.files.length; index++) {
                            var file = cards.files.item(index);
                            
                            var reader = new FileReader();
                            reader.onload = function(event) {
                                var cardImg = document.createElement('img');
                                cardImg.src = event.target.result;
    
                                cardImg.addEventListener("load", () => {
                                    createThumbnail(cardImg, index + parseInt(correction), base)
                                });
    
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                };
                
                bgReader.readAsDataURL(backgroundFile);
            }


        </script>

    </head>
    <body>
        <div>
            
            <div class="mb-3 fileSelect">
                <label for="fileBackground" class="form-label">Plik tła</label>
                <input class="form-control" type="file" id="fileBackground">
              </div>
            <div class="mb-3 fileSelect">
                <label for="fileItems" class="form-label">Pliki kart</label>
                <input class="form-control" type="file" id="fileItems" multiple>
            </div>
            <div class="mb-3 fileSelect">
                <label for="fileItems" class="form-label">Kolor napisu</label>
                <input class="form-control" id="MainColor" value="#000000">
            </div>
            <div class="mb-3 fileSelect">
                <label for="fileItems" class="form-label">Kolor Tła</label>
                <input class="form-control" id="BgColor" value="#ffffff">
            </div>
            <div class="mb-3 fileSelect">
                <label for="fileItems" class="form-label">Korekta tła napisu</label>
                <input class="form-control" id="BgCorrection" value="-4">
            </div>
            <div class="input-group mb-3 fileSelect">
                <span class="input-group-text" id="basic-addon1">Zacznij od odcinka numer</span>
                <input type="text" class="form-control" id="thumbnailCount">
            </div>
            <div class="mb-3 fileSelect">
                <button onclick="generateThumbnails()" type="button" class="btn btn-primary" style="width: 100%;">Generuj #wc3 Thumbnail</button>
            </div>

        </div>

        <table id="toSort" class="sortable table">
            <thead>
                <tr>
                  <th>id</th>
                  <th>Thumbnail</th>
                </tr>
              </thead>
              <tbody id="main">

              </tbody>
        </table>

    </body>
</html>